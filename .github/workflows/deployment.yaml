# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ** Deployment **
#
#  Test deployments are handled by a python script that run on a schedule: https://github.com/Catrobat/Catroweb-API
#  However, the deployment to production is handled by this workflow.
#
#  - Secrets required!
#
name: Deployment

# Run-on every merge of a pull request into the main branch
on:
  push:
    branches:
      - main

# The concurrency: production_environment is important as it prevents concurrent deploys.
concurrency: production_environment

jobs:
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Deployment:
  #
  #  - An SSH connection is required (public key must be registered on server!)
  #  - Add all credentials hidden in secrets to the configuration files
  #
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: 'Setup PHP and composer packages'
        uses: ./.github/actions/setup-php-composer

      - name: Deploy Share
        uses: deployphp/action@v1
        with:
          private-key: ${{ secrets.DEPLOY_SHARE_SSH_KEY }}
          dep: deploy
        env:
          APP_NAME: Catroweb
          DEPLOY_GIT: https://github.com/Catrobat/Catroweb.git
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_BRANCH: main
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
