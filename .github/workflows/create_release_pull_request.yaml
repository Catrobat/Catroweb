# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ** Release preparation **
#
#  This workflow create 2 pull requests branching from develop into:
#     - master
#     - develop
#
#  The pull request contains:
#     - Bump release version -> .env
#     - Changelog
#     - New release tag
#
name: Create Release PR

on:
  workflow_dispatch:

jobs:
  createRelease_01:
    name: Create Pull Request to master
    runs-on: ubuntu-latest

    outputs:
      new_version: ${{ steps.calculate_version.outputs.new_version }}
      release_notes: ${{ steps.generate_notes.outputs.release_notes }}

    steps:
      - uses: actions/checkout@v4

      - name: Calculate new version
        id: calculate_version
        run: |
          # Extract the current version from the .env file
          current_version=$(grep -oP "(?<=APP_VERSION=')[0-9]{2}\.[0-9]{1,2}\.[0-9]{1,5}" .env)
          
          # Extract year, month, and patch from the current version
          year=${current_version:0:2}
          month=${current_version:3:2}
          patch=${current_version:6}
          
          # Increment the patch version
          new_patch=$((patch + 1))
          
          # Get current year and month
          current_year=$(date +%y)
          current_month=$(date +%-m)
          
          # If the current year or month is different, reset the patch version
          if [[ $year -ne $current_year || $month -ne $current_month ]]; then
            new_patch=0
          fi
          
          # Ensure the month is always two digits
          formatted_month=$(printf "%02d" $current_month)
          
          # Formulate the new version
          new_version="${current_year}.${formatted_month}.${new_patch}"
          
          # Output the new version
          echo "new_version=$new_version" >> $GITHUB_ENV

      - name: Generate Release Notes
        id: generate_notes
        run: |
          notes=$(git log --pretty=format:"* %s" `git describe --tags --abbrev=0`..HEAD)
          echo "release_notes=$notes" >> $GITHUB_ENV
          echo "::set-output name=release_notes::$notes"

      # The changes here will be overwritten, however we need changes, else the PR will be automatically closed by GitHub
      - name: Dummy Changes to keep PR open
        run: |
          echo "Dummy Change" >> .env

      - name: Create Pull Request to master branch
        id: cpr-main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Prepare release v${{ steps.calculate_version.outputs.new_version }}
          committer: Catrobot <Catrobot@catroweb.github.com>
          title: 'Release v${{ steps.calculate_version.outputs.new_version }} into master'
          body: |
            ### Release v${{ steps.calculate_version.outputs.new_version }}

            Release ToDo List:
              - [X] Bump our version code
              - [X] Update Changelog
              - [X] Create new Release/Tag on GitHub

            This pull request is autogenerated using GitHub Actions.
            For more information checkout the action '.github/workflows/create_release_pull_request.yaml'
          labels: automated, new-release, master
          branch: release/v${{ steps.calculate_version.outputs.new_version }}
          delete-branch: true
          reviewers: dmetzner
          base: master

  createRelease_02:
    name: Create Pull Request to develop
    runs-on: ubuntu-latest
    needs: createRelease_01

    steps:
      - uses: actions/checkout@v4

      - name: Set Version Code
        run: |
          sed -i -E "s/APP_VERSION='[0-9]+\.[0-9]+\.[0-9]+'/APP_VERSION='${{ needs.createRelease_01.outputs.new_version }}'/" .env

      - name: 'Setup Node and npm modules'
        uses: ./.github/actions/setup-npm-node-modules

      - name: Update Release Notes
        run: |
          echo -e "## v${{ needs.createRelease_01.outputs.new_version }}\n${{ needs.createRelease_01.outputs.release_notes }}\n" >> CHANGELOG.md
          npm run fix-asset

      - name: Commit changes
        run: |
          git config --global user.name "Catrobot"
          git config --global user.email "Catrobot@catroweb.github.com"
          git commit -am "Bump version to ${{ needs.createRelease_01.outputs.new_version }}"

      - name: Create Pull Request to develop branch
        id: cpr-develop
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Prepare release v${{ needs.createRelease_01.outputs.new_version }}
          committer: Catrobot <Catrobot@catroweb.github.com>
          title: 'Release v${{ needs.createRelease_01.outputs.new_version }} into develop'
          body: |
            ### Release v${{ needs.createRelease_01.outputs.new_version }}

            Release ToDo List:
              - [X] Bump our version code
              - [X] Update Changelog
              - [X] Create new Release/Tag on GitHub

            This pull request is autogenerated using GitHub Actions.
            For more information checkout the action '.github/workflows/create_release_pull_request.yaml'
          labels: automated, new-release
          branch: release/v${{ needs.createRelease_01.outputs.new_version }}
          delete-branch: true
          reviewers: dmetzner
          base: develop

  createReleaseTag:
    name: Create GitHub Release v${{ needs.createRelease_01.outputs.new_version }}
    runs-on: ubuntu-latest
    needs: [createRelease_01, createRelease_02]

    steps:
      - uses: actions/checkout@v4

      - name: Checkout Release Branch
        run: git checkout release/v${{ needs.createRelease_01.outputs.new_version }}

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create v${{ needs.createRelease_01.outputs.new_version }} --target release/v${{ needs.createRelease_01.outputs.new_version }} -t "v${{ needs.createRelease_01.outputs.new_version }}" -n "${{ needs.createRelease_01.outputs.release_notes }}"
