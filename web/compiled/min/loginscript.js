function triggerFacebookLogin(){FB.login(function(response){response.authResponse?(console.log("Facebook Login successful"),checkLoginState()):console.log("User cancelled login or did not fully authorize.")},{scope:"public_profile,email",return_scopes:!0,auth_type:$("#facebook_auth_type").val()})}function checkLoginState(){console.log("checkLoginState"),FB.getLoginStatus(function(response){statusChangeCallback(response)})}function statusChangeCallback(response){"connected"===response.status?($("#access_token_oauth").val(response.authResponse.accessToken),getFacebookUserInfo()):"not_authorized"===response.status?document.getElementById("status").innerHTML="Please sign in to Pocket Code":document.getElementById("status").innerHTML="Please log into Facebook"}function getFacebookUserInfo(){console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(response){console.log("Successful login for: "+response.name),console.log("First name:"+response.first_name),console.log("Last name:"+response.last_name),console.log("Name:"+response.name),console.log("Response ID:"+response.id),console.log("Country:"+response.locale),$("#id_oauth").val(response.id),$("#email_oauth").val(response.email),$("#locale_oauth").val(response.locale),handleFacebookUserInfoResponseTrigger()})}function getDesiredUsernameFB(){$("#fb_google").val("fb"),openDialog()}function sendTokenToServer($token,$facebook_id,$username,$email,$locale){var $state=$("#csrf_token").val(),$ajaxUrl=Routing.generate("catrobat_oauth_login_facebook_token",{flavor:"pocketcode"});$.post($ajaxUrl,{client_token:$token,id:$facebook_id,state:$state,username:$username,email:$email,locale:$locale},function(data,status){console.log(data),console.log(status),FacebookLogin($email,$username,$facebook_id,$locale)})}function FacebookLogin($email,$username,$id,$locale){var $ajaxUrl=Routing.generate("catrobat_oauth_login_facebook",{flavor:"pocketcode"});$.post($ajaxUrl,{username:$username,id:$id,email:$email,locale:$locale},function(data,status){var $ajaxLoginRedirectUrl=Routing.generate("catrobat_oauth_login_redirect",{flavor:"pocketcode"});$.post($ajaxLoginRedirectUrl,{fb_id:$id},function(data,status){console.log(data),$url=data.url,$(location).attr("href",$url)})})}function FacebookLogout(){FB.getLoginStatus(function(response){"connected"===response.status&&FB.logout(function(logout_response){console.log("User logged out of Facebook with response:"),console.log(logout_response)})},!0)}function triggerGoogleLogin(){var $ajaxGetGoogleAppId=Routing.generate("catrobat_oauth_login_get_google_appid",{flavor:"pocketcode"});$.get($ajaxGetGoogleAppId,function(data){console.log(data);var $appid=data.gplus_appid;gapi.signin.render("googleLoginButton",{callback:"signinCallback",approvalprompt:$("#gplus_approval_prompt").val(),clientid:$appid,cookiepolicy:"single_host_origin",redirecturi:"postmessage",accesstype:"offline",scope:"https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email"})})}function signinCallback(authResult){authResult.code?($("#access_token_oauth").val(authResult.code),console.log("auth: "+authResult.code),getGoogleUserInfo(authResult)):authResult.error&&("access_denied"==authResult.error?console.log("User denied access to the app"):"immediate_failed"==authResult.error?console.log("Automatic sign-in of user failed"):console.log("error:"+authResult.error))}function getGoogleUserInfo(authResult){function getUserInfoCallback(obj){obj.email&&$("#email_oauth").val(obj.email),obj.id&&$("#id_oauth").val(obj.id),obj.locale&&$("#locale_oauth").val(obj.locale),checkGoogleCallbackDataWithServer()}gapi.client.load("oauth2","v2",function(){var request=gapi.client.oauth2.userinfo.get();request.execute(getUserInfoCallback)})}function checkGoogleCallbackDataWithServer(){$id=$("#id_oauth").val(),$email=$("#email_oauth").val(),$locale=$("#locale_oauth").val();var $ajaxUrlCheckServerTokenAvailable=Routing.generate("catrobat_oauth_login_google_servertoken_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckServerTokenAvailable,{id:$id},function(data){console.log(data);var $server_token_available=data.token_available;if($server_token_available)GoogleLogin(data.email,data.username,$id,$locale);else{$("#id_oauth").val($id),$("#email_oauth").val($email),$("#locale_oauth").val($locale);var $ajaxUrlCheckEmailAvailable=Routing.generate("catrobat_oauth_login_email_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckEmailAvailable,{email:$email},function(data,status){console.log(data),console.log(status),0==data.email_available?getDesiredUsernameGoogle():sendCodeToServer($("#access_token_oauth").val(),$id,data.username,$email,$locale)})}})}function getDesiredUsernameGoogle(){$("#fb_google").val("g+"),openDialog()}function sendCodeToServer($code,$gplus_id,$username,$email,$locale){var $state=$("#csrf_token").val(),$ajaxUrl=Routing.generate("catrobat_oauth_login_google_code",{flavor:"pocketcode"});$.post($ajaxUrl,{code:$code,id:$gplus_id,state:$state,username:$username,email:$email,locale:$locale},function(data,status){console.log(status),console.log(data),GoogleLogin($email,$username,$gplus_id,$locale)})}function GoogleLogin($email,$username,$id,$locale){var $ajaxUrl=Routing.generate("catrobat_oauth_login_google",{flavor:"pocketcode"});$.post($ajaxUrl,{username:$username,id:$id,email:$email,locale:$locale},function(data,status){var $ajaxLoginRedirectUrl=Routing.generate("catrobat_oauth_login_redirect",{flavor:"pocketcode"});$.post($ajaxLoginRedirectUrl,{gplus_id:$id},function(data,status){console.log(data),$url=data.url,$(location).attr("href",$url)})})}function GoogleLogout(){var $ajaxGetGoogleAppId=Routing.generate("catrobat_oauth_login_get_google_appid",{flavor:"pocketcode"});$.get($ajaxGetGoogleAppId,function(data){var sessionParams={client_id:data.gplus_appid,session_state:null};gapi.auth.checkSessionState(sessionParams,function(connected){connected&&gapi.auth.signOut()})})}function openDialog(){$("#dialog-oauth-username").dialog("open");var dark_background=$('<div id="bg-dark"></div>');dark_background.css({position:"fixed",width:"100%",height:"100%","background-color":"black",left:"0",top:"0",opacity:"0.5"}),$("body").append(dark_background)}function getTwitterShareUrl(){return $twitterShareBaseUrl="http://twitter.com/share?url=",$twitterShareBaseUrl+=window.location.href,console.log($twitterShareBaseUrl),$twitterShareBaseUrl}function triggerShareOnTwitter(){window.open(getTwitterShareUrl(),"Twitter","width=490,height=530")}function triggerShareViaMail($programName,$programDescription,$checkoutThisProgramMessage){var newLine="%0D%0A",subject=$programName,body=$checkoutThisProgramMessage+":"+newLine+window.location.href+newLine+newLine+$programDescription,link="mailto:?subject="+subject+"&body="+body;window.location.href=link}function appendFacebookAppIdToShareLink($facebookPlusShareBaseUrl){var $ajaxGetFBAppId=Routing.generate("catrobat_oauth_login_get_facebook_appid",{flavor:"pocketcode"});$.get($ajaxGetFBAppId,function(data){console.log(data),$facebookPlusShareBaseUrl+=data.fb_appid,$facebookPlusShareBaseUrl+="&display=popup&href=",$facebookPlusShareBaseUrl+=window.location.href,console.log($facebookPlusShareBaseUrl),window.open($facebookPlusShareBaseUrl,"Facebook","width=490,height=530")})}function triggerShareOnFacebook(){$facebookPlusShareBaseUrl="https://www.facebook.com/dialog/share?app_id=",appendFacebookAppIdToShareLink($facebookPlusShareBaseUrl)}function getGooglePlusShareUrl(){return $googlePlusShareBaseUrl="https://plus.google.com/share?url=",$googlePlusShareBaseUrl+=window.location.href,console.log($googlePlusShareBaseUrl),$googlePlusShareBaseUrl}function triggerShareOnGooglePlus(){window.open(getGooglePlusShareUrl(),"Google+","width=490,height=530")}$(document).ready(function(){$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/en_US/sdk.js",function(){var $appid="",$ajaxGetFBAppId=Routing.generate("catrobat_oauth_login_get_facebook_appid",{flavor:"pocketcode"});$.get($ajaxGetFBAppId,function(data){console.log(data),$appid=data.fb_appid,FB.init({appId:$appid,xfbml:!0,status:!0,cookie:!0,version:"v2.1"})})}),$("#logout").click(function(){FacebookLogout()}),$("#_submit_oauth").attr("disabled",!0)});var handleFacebookUserInfoResponseTrigger=function(){$id=$("#id_oauth").val(),$email=$("#email_oauth").val(),$locale=$("#locale_oauth").val();var $ajaxUrlCheckServerTokenAvailable=Routing.generate("catrobat_oauth_login_facebook_servertoken_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckServerTokenAvailable,{id:$id},function(data,status){console.log(data),console.log(status);var $server_token_available=data.token_available;if($server_token_available)FacebookLogin(data.email,data.username,$id,$locale);else{var $ajaxUrlCheckEmailAvailable=Routing.generate("catrobat_oauth_login_email_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckEmailAvailable,{email:$email},function(data,status){console.log(data),console.log(status),0==data.email_available?getDesiredUsernameFB():sendTokenToServer($("#access_token_oauth").val(),$id,data.username,$email,$locale)})}})};$(document).ready(function(){var po=document.createElement("script");po.type="text/javascript",po.async=!0,po.src="https://apis.google.com/js/client:plusone.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(po,s),$("#logout").click(function(){GoogleLogout()}),$("#_submit_oauth").attr("disabled",!0)}),$(document).ready(function(){if($("#btn_oauth_username").attr("disabled","disabled"),$("#dialog_oauth_username_input").on("input",function(e){$("#error_username_taken").css("display","none"),""!=$("#dialog_oauth_username_input").val().trim()?($("#btn_oauth_username").removeAttr("disabled"),$("#btn_oauth_username").css({opacity:1})):($("#btn_oauth_username").attr("disabled","disabled"),$("#btn_oauth_username").css({opacity:.5}))}),$("#dialog-oauth-username").on("dialogclose",function(event,ui){$("#bg-dark").remove()}),$("#btn_oauth_username").click(function(){var $ajaxUrl=Routing.generate("catrobat_oauth_login_username_available",{flavor:"pocketcode"});$.post($ajaxUrl,{username:$("#dialog_oauth_username_input").val()},function(data){1==data.username_available?$("#error_username_taken").css("display","block"):"fb"==$("#fb_google").val()?sendTokenToServer($("#access_token_oauth").val(),$("#id_oauth").val(),$("#dialog_oauth_username_input").val(),$("#email_oauth").val(),$("#locale_oauth").val()):"g+"==$("#fb_google").val()&&sendCodeToServer($("#access_token_oauth").val(),$("#id_oauth").val(),$("#dialog_oauth_username_input").val(),$("#email_oauth").val(),$("#locale_oauth").val())})}),""==$("#csrf_token_oauth").val()){var $ajaxUrl=Routing.generate("catrobat_oauth_register_get_csrftoken",{flavor:"pocketcode"});$.get($ajaxUrl,function(data){console.log(data),$("#csrf_token_oauth").val(data.csrf_token)})}}),$(function(){var $dialogSelector=$("#dialog-oauth-username");$dialogSelector.length&&$dialogSelector.dialog({autoOpen:!1})});